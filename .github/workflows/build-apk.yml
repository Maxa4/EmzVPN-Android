name: Build APK and Release

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: Grant gradlew permissions
      run: chmod +x gradlew
      
    - name: Cache Gradle
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: Build Debug APK
      run: ./gradlew assembleDebug --no-daemon
      
    - name: Build Release APK
      run: |
        ./gradlew assembleRelease --no-daemon
        # –°–æ–∑–¥–∞–µ–º –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–π APK (debug –ø–æ–¥–ø–∏—Å—å –¥–ª—è —Ç–µ—Å—Ç–∞)
        cd app/build/outputs/apk/release
        jarsigner -verbose -sigalg SHA1withRSA -digestalg SHA1 \
          -keystore <(echo '${{ secrets.KEYSTORE }}') \
          -storepass '${{ secrets.KEYSTORE_PASSWORD }}' \
          -keypass '${{ secrets.KEY_PASSWORD }}' \
          app-release-unsigned.apk key0
        zipalign -v 4 app-release-unsigned.apk FreeVPN-signed.apk
      if: ${{ secrets.KEYSTORE }}
      env:
        KEYSTORE: ${{ secrets.KEYSTORE }}
        KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
        KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        
    - name: Upload Debug APK
      uses: actions/upload-artifact@v4
      with:
        name: freevpn-debug
        path: app/build/outputs/apk/debug/
        retention-days: 7
        
    - name: Upload Release APK
      uses: actions/upload-artifact@v4
      with:
        name: freevpn-release
        path: app/build/outputs/apk/release/
        retention-days: 7
      if: ${{ secrets.KEYSTORE }}
      
    - name: Create GitHub Release
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v1.0.${{ github.run_number }}
        name: Free VPN v1.0.${{ github.run_number }}
        body: |
          ## üöÄ Free VPN –¥–ª—è Android
          
          ### –°–±–æ—Ä–∫–∞ #${{ github.run_number }}
          
          **–î–∞—Ç–∞:** ${{ github.event.head_commit.timestamp }}
          
          **–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
          ${{ github.event.head_commit.message }}
          
          ### üì¶ –§–∞–π–ª—ã:
          - `app-debug.apk` - –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
          - `FreeVPN-signed.apk` - –ø–æ–¥–ø–∏—Å–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è
          
          ### üì± –£—Å—Ç–∞–Ω–æ–≤–∫–∞:
          1. –°–∫–∞—á–∞–π—Ç–µ APK —Ñ–∞–π–ª
          2. –ù–∞ Android —Ä–∞–∑—Ä–µ—à–∏—Ç–µ "–£—Å—Ç–∞–Ω–æ–≤–∫—É –∏–∑ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤"
          3. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
          
          ### ‚ö†Ô∏è –í–∞–∂–Ω–æ:
          - –≠—Ç–æ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
          - –°–µ—Ä–≤–µ—Ä—ã –º–æ–≥—É—Ç –±—ã—Ç—å –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω—ã
          - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–ª—è –ª–µ–≥–∞–ª—å–Ω—ã—Ö —Ü–µ–ª–µ–π
          
          ### üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:
          - –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è Android: 5.0 (API 21)
          - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç OpenVPN
          - –ë–µ–∑ —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö
        files: |
          app/build/outputs/apk/debug/app-debug.apk
          ${{ secrets.KEYSTORE && 'app/build/outputs/apk/release/FreeVPN-signed.apk' || '' }}
        draft: false
        prerelease: false
        
    - name: Generate QR Code
      uses: peter-evans/qr-code-generator@v1
      with:
        text: "https://github.com/${{ github.repository }}/releases/download/v1.0.${{ github.run_number }}/app-debug.apk"
        size: 256
        name: qr-code.png
        
    - name: Upload QR Code to Release
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v1.0.${{ github.run_number }}
        files: qr-code.png
